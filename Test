import org.w3c.dom.*;
import javax.xml.parsers.*;
import javax.xml.transform.*;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;
import java.io.*;
import java.util.*;

public class XMLProcessor {
    public static void main(String[] args) {
        String inputFolderPath = "input_xmls";  // Folder containing XML files
        String outputBasePath = "output_xmls";  // Base output folder

        // Predefined list of states to process
        List<String> claimLossStates = List.of("Florida", "New York", "Pennsylvania", "Texas", "California");

        // Special states with multiple LOBs
        Map<String, List<String>> specialStatesLobs = Map.of(
            "Florida", List.of("PERSONAL AUTOMOBILE", "COMMERCIAL AUTOMOBILE", "RESIDENTIAL PROPERTY", "COMMERCIAL PROPERTY", "VALUABLE ARTICLES"),
            "New York", List.of("PERSONAL AUTOMOBILE", "COMMERCIAL AUTOMOBILE", "OTHER"),
            "Pennsylvania", List.of("PERSONAL AUTOMOBILE", "COMMERCIAL AUTOMOBILE", "OTHER")
        );

        File inputFolder = new File(inputFolderPath);
        File[] xmlFiles = inputFolder.listFiles((dir, name) -> name.toLowerCase().endsWith(".xml"));

        if (xmlFiles == null || xmlFiles.length == 0) {
            System.out.println("No XML files found in " + inputFolderPath);
            return;
        }

        int globalTcCounter = 1; // Global Test Case Counter

        for (File xmlFile : xmlFiles) {
            globalTcCounter = processXMLFile(xmlFile, outputBasePath, claimLossStates, specialStatesLobs, globalTcCounter);
        }

        System.out.println("XML processing completed!");
    }

    public static int processXMLFile(File xmlFile, String outputBasePath, List<String> claimLossStates, Map<String, List<String>> specialStatesLobs, int globalTcCounter) {
        try {
            DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
            DocumentBuilder builder = factory.newDocumentBuilder();
            Document doc = builder.parse(xmlFile);
            doc.getDocumentElement().normalize();

            NodeList stateNodes = doc.getElementsByTagName("CLAIM_LOSS_STATE");
            if (stateNodes.getLength() == 0) {
                System.out.println("Skipping file (No CLAIM_LOSS_STATE found): " + xmlFile.getName());
                return globalTcCounter;
            }

            Set<String> uniqueStates = new HashSet<>();
            for (int i = 0; i < stateNodes.getLength(); i++) {
                String state = stateNodes.item(i).getTextContent().trim();
                if (claimLossStates.contains(state)) {
                    uniqueStates.add(state);
                }
            }

            if (uniqueStates.isEmpty()) {
                System.out.println("Skipping file (No matching CLAIM_LOSS_STATE found): " + xmlFile.getName());
                return globalTcCounter;
            }

            String baseFileName = xmlFile.getName().replaceFirst("[.][^.]+$", "");
            String outputFolderPath = outputBasePath + "/" + baseFileName;
            File outputFolder = new File(outputFolderPath);
            if (!outputFolder.exists()) {
                outputFolder.mkdirs();
            }

            for (String state : uniqueStates) {
                if (specialStatesLobs.containsKey(state)) {
                    for (String claimLob : specialStatesLobs.get(state)) {
                        globalTcCounter = generateXML(xmlFile, outputFolderPath, baseFileName, state, claimLob, globalTcCounter);
                    }
                } else {
                    globalTcCounter = generateXML(xmlFile, outputFolderPath, baseFileName, state, null, globalTcCounter);
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        return globalTcCounter;
    }

    public static int generateXML(File inputFile, String outputFolderPath, String baseFileName, String claimLossState, String claimLob, int globalTcCounter) {
        try {
            DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
            DocumentBuilder builder = factory.newDocumentBuilder();
            Document doc = builder.parse(inputFile);
            doc.getDocumentElement().normalize();

            updateXMLTagValue(doc, "CLAIM_LOSS_STATE", claimLossState);
            if (claimLob != null) {
                updateXMLTagValue(doc, "CLAIM_LOB", claimLob);
            }

            String outputFileName = (claimLob == null) ?
                    String.format("%s_TC%02d_%s.xml", baseFileName, globalTcCounter++, claimLossState) :
                    String.format("%s_TC%02d_%s_%s.xml", baseFileName, globalTcCounter++, claimLossState, claimLob.replace(" ", "_"));

            String outputPath = outputFolderPath + "/" + outputFileName;

            saveXMLFile(doc, outputPath);
            System.out.println("Generated: " + outputPath);
        } catch (Exception e) {
            e.printStackTrace();
        }
        return globalTcCounter;
    }

    public static void updateXMLTagValue(Document doc, String tagName, String newValue) {
        NodeList nodeList = doc.getElementsByTagName(tagName);
        if (nodeList.getLength() == 0) {
            return;
        }

        for (int i = 0; i < nodeList.getLength(); i++) {
            Node node = nodeList.item(i);
            if (node.getNodeType() == Node.ELEMENT_NODE) {
                node.setTextContent(newValue);
            }
        }
    }

    public static void saveXMLFile(Document doc, String filePath) {
        try {
            TransformerFactory transformerFactory = TransformerFactory.newInstance();
            Transformer transformer = transformerFactory.newTransformer();
            transformer.setOutputProperty(OutputKeys.INDENT, "yes");
            DOMSource source = new DOMSource(doc);
            StreamResult result = new StreamResult(new File(filePath));
            transformer.transform(source, result);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
